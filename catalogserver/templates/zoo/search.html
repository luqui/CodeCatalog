{% extends "zoo/frame.html" %}

{% block pagetitle %}
CodeCatalog Search
{% endblock %}

{% block header %}
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>

<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css" />
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>

<script src='/static/code_editor.js'></script>

{{ block.super }}

<style>
 .searchbox { 
    margin-top: 20px;
    margin-bottom: 20px;
 }
 .searchbox .center-aligned { text-align: center }
 .searchbox input { height: 30px; font-size: large }
 .searchbox #q { width: 800px }
 
 .navigation_div {
    text-align: center;
    margin-top: 1cm;
    margin-bottom:20px;
 }
 
 .navigation_div a {
    color: blue;
    font-size: 14pt;
    font-family: sans-serif;
 }
 
 #q {
    font-size: 16pt;
 }
 
 .results_area { 
    display: block; 
    margin: auto;
 }

.results_area table {
    margin: auto;
    border-style: hidden;
    border-collapse: collapse;
    border-spacing: 0px;
    border-width: 0px;
    /*border-color: #e3ddf3;*/
    width: 800px;
 }
 
.results_area td {
    /* border-color: #e3ddf3; */
    border-width: 1px;
    border-style: inset;
    border: none;
    border-bottom: 1px solid #e3ddf3;
    padding: 10px 16px;
 }
 
 .results_area td.firstchild {
    width: 200px;
    border-right: 4px solid #e3ddf3;
 }
 
 .result_name {
    font-size: 14pt;
 }
 
 .result_summary {
    font-size: 12pt;
 }
 
 .results_area tr.focused td {
    border-color: #b0aac0;
    border-bottom: 1px solid #e3ddf3;
 }
 
 .results_area tr.focused {
    background: #e3ddf3;
 }
 
 .results_area tr.firstchild .result_name {
    font-size: 16pt;
    font-weight: bold;
 }
 
 .results_area tr.firstchild .result_summary {
    font-size: 14pt;
 }
 
 .no_results {
    padding-top: 50px;
    font-size: 16pt;
    text-align: center;
 }
 
</style>

<script>

//CodeCatalog Snippet http://codecatalog.net/279/782/
var foreach = function(array, body) {
    for (var i = 0; i < array.length; ++i) {
        body(array[i]);
    }
};
// End CodeCatalog Snippet

// CodeCatalog Snippet http://www.codecatalog.net/175/1/
var rate_limited_callback = function(rate, cb) {
    var timeout = null;

    return function() {
        if (timeout) { clearTimeout(timeout); timeout = null; }
        timeout = setTimeout(cb, rate);
    };
};
// End CodeCatalog Snippet

// CodeCatalog Snippet http://www.codecatalog.net/16/3/
var elt = function(name, attrs) {
    var r = $(document.createElement(name));
    if (attrs) {
        for (var i in attrs) {
            r.attr(i, attrs[i]);
        }
    }
    for (var i = 2; i < arguments.length; ++i) {
        r.append(arguments[i]);
    }
    return r;
};
// End CodeCatalog Snippet

// CodeCatalog Snippet http://www.codecatalog.net/254/7/
var table_row = function() {
    var tr = elt('tr');
    foreach(arguments, function(arg) {
        tr.append(elt('td', {}, arg));
    });
    return tr;
};
// End CodeCatalog Snippet

// CodeCatalog Snippet http://www.codecatalog.net/256/1/
var text_node = function(text) { return document.createTextNode(text) };
// End CodeCatalog Snippet

var spec_to_address = function(spec) {
    return '/' + spec.versionptr + '/'
};

var search_box = function(e_search_input, e_search_results, go_func) {
    var top_result = null;
    var top_result_tr = null;
    var results_listing = [];
    var searching = false;
    var enter_while_searching = false;
    var next_search_id = 0;
    var last_search_id = 0;
    
    var results_table = null;
    
    var focus_tr = function(tr) {
        var old_index = results_listing.indexOf(tr);
        tr = $(tr);
        if (old_index >= 0) {
            results_listing[old_index] = tr;
        }
        results_table.find('tr').removeClass('focused');
        tr.addClass('focused');
        top_result = tr.data('spec');
        top_result_tr = tr;
        
        /*
        $.get('/api/specs/' + top_result.versionptr + '/active/', function(r) {
            console.log("FOCUSED: ");
            console.log(r.name + " - " + r.summary);
        });*/
        
        //console.log("Updated?");
        //console.log(results_listing.indexOf(tr));
    };
    
    var do_search = function() {
        // do a search for the text
        var query = e_search_input.val();
        if (query.length < 3) {
            e_search_results.empty();
            return;
        }
        
        if (!searching) {
            searching = true;
            enter_while_searching = false;
        }
        
        var search_id = next_search_id = next_search_id + 1;
        
        $.get('/api/search/', { q: query }, function(results) {
            
            if (last_search_id > search_id) {
                return;
            }
            last_search_id = search_id;
            
            results_table = elt('table');
            results_listing = [];
            
            top_result = null;
            if (results.length > 0) {              
                e_search_input.trigger('search',[query]);
                
                foreach(results, function(result) {
                    var result_row = table_row(
                            elt('a', {'href': spec_to_address(result), 'class': 'result_name'}).text(result.name), 
                            elt('span', {'class': 'result_summary'}).text(result.summary));
                    
                    result_row.data('spec', result);
                    results_table.append(result_row);
                });
                
                results_table.find(':first-child').addClass('firstchild');
                
                results_table.find('tr').each(function(_, tr) {
                    var tr_element = $(tr);
                    
                    results_listing.push(tr_element);
                    
                    tr_element.mouseover(function() {
                        focus_tr(tr_element);
                    });
                    
                    if (top_result == null) {
                        focus_tr(tr_element); // Sets top_result to result_row, among other things.
                    }
                });
                results_table.mouseout(function() {
                    focus_tr(results_table.find('tr:first-child'));
                });
            }
            else {
                results_table = elt('div', {'class': 'no_results'}).text("no results");
            }
            
            searching = false;
            if (enter_while_searching) {
                go_func(top_result);
            }
            else { 
                e_search_results.empty();
                e_search_results.append(results_table);
            }
        });
    };
    
    var do_search_rate_limited = rate_limited_callback(300, do_search)
    
    var on_search_edit = function(e){
        if (e.keyCode == 38 /* UP */) {
            var index = results_listing.indexOf(top_result_tr);
            if (index > 0) {
                var prev = results_listing[index - 1];
                focus_tr(prev);
            }
        }
        else if (e.keyCode == 40 /* DOWN */) {
            var index = results_listing.indexOf(top_result_tr);
            if (index >= 0 && index < results_listing.length - 1) {
                var next = results_listing[index + 1];
                focus_tr(next);
            }
        }
        else if (e.keyCode == 13 /* ENTER */) {
            if (!go_func(top_result)) {
                var was_searching = searching;
                searching = true;
                enter_while_searching = true;
                if (!was_searching) {
                    do_search();
                }
            }
        }
        else
        {
            do_search_rate_limited();
        }
    };
    
    e_search_input.keydown(on_search_edit); 
    e_search_input.focus();
    // Call do_search immediately in-case there was a reload of the page with text in the input box.
    do_search();
};

$(function() {
    var search_input = $('#q');
    var search_results = $('#search_results');
    
    var go_func = function(choice) {
        if (choice != null) {
            window.location.href = spec_to_address(choice);
            return true;
        }
        return false;
    };
    
    search_box(search_input, search_results, go_func);
    
});

</script>
{% endblock %}

{% block content %}

<div class='navigation_div'><a href='/new'>Add Code</a></div>

<div class='searchbox'>
 <div class='center-aligned'>
  <input type='text' name='q' id='q' />
 </div>
</div>

<center>
 <div name='search_results' id='search_results' class='results_area'></div>
</center>

{% endblock content %}
