<html>
 <head>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>

  <link rel="stylesheet" type="text/css" href="/static/site.css" />
  
  {% block header %}
  {% endblock %}

  <style>
   .site { width: 900px; margin: auto }
   .centered { width: 480px; margin: auto }
   a.new_events { background: #c00; color: white }
   .events_table { background: silver }
   .events_table td { border: 1px solid black }
  </style>

  <script>
    // CodeCatalog Snippet http://codecatalog.net/119/
    var elt = function(name, attrs) {
        var r = $(document.createElement(name));
        if (attrs) {
            for (var i in attrs) {
                r.attr(i, attrs[i]);
            }
        }
        for (var i = 2; i < arguments.length; ++i) {
            r.append(arguments[i]);
        }
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://codecatalog.net/87/231/
    var dropdown = function(clicker, make_elements) {
        var div = elt('div', {}, clicker);
        var onclick = function() {
            var list = elt('table');
            div.append(list);
            clicker.unbind('click');
            clicker.click(function() {
                clicker.unbind('click');
                list.remove();
                clicker.click(onclick);
                return false;
            });

            make_elements(function(e) {
                list.append(elt('tr', {}, elt('td', {}, e)));
            });
        };
        clicker.click(onclick);
        return div;
    };
    // End CodeCatalog Snippet

{% if user.is_authenticated %}
    $(function() {
        $.get('/api/user/events/check/', function (hasEvents) {
            if (!hasEvents) return;
            $('#events').append(
                dropdown(elt('a', { href:'#' }).addClass('new_events').text("New Events"), function(adder) {
                    $.get('/api/user/events/new/', function (events) {
                        events.forEach(function(e) {
                            var target = '/' + e.versionptr + '/';
                            var link = elt('a', { href: '#' }).text(e.name);
                            link.click(function() {
                                $.post('/api/user/events/mark_viewed/',
                                    { versionptr: e.versionptr },
                                    function () { window.location.href = target });
                                return false;
                            });
                            if (e.type == 'new_version') {
                                adder(elt('p').text('New version of ').append(link));
                            }
                            else if (e.type == 'bug') {
                                adder(elt('p').text('Bug report: "' + e.bug_title + '" on ').append(link));
                            }
                            else if (e.type == 'vote' && e.value > 0) {
                                adder(elt('p').text('Upvote on ').append(link));
                            }
                            else if (e.type == 'vote' && e.value < 0) {
                                adder(elt('p').text('Downvote on ').append(link));
                            }
                        });
                    });
                }).addClass('events_table')
            );
        });
    });
{% endif %}
  </script>

 </head>
 <body>
  <div class="site">
   <div class="userpanel">
    <table width="100%">
     <tr>
      <td>
       {% if user.is_authenticated %}
        <b><a href="/profile/">{{user.username}}</a></b> (<a href="/logout/">logout</a>)
       {% else %}
        <a href="/openid/login/">login</a>
       {% endif %}
      </td> 
      <td>
       {% if user.is_authenticated %}
        <div id="events"></div>
       {% endif %}
      </td>
      <td style="text-align: right">
       <a href="/search/">New / Search</a>
     </tr>
    </table>
   </div>
   <div class="centered">
    <a href="/"><img src="/static/banner.png" /></a>
   </div>
   {% block content %}
   {% endblock %}
  </div>


 </body>
</html>

