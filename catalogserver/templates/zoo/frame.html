<html>
 <head>
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
  <script src='/static/json2.js'></script>

  {% block header %}
  {% endblock %}

  <style>
   .site { width: 900px; margin: auto }
   .centered { width: 480px; margin: auto }
   a.new_events { background: #c00; color: white }
   .events_table { background: silver }
   .events_table td { border: 1px solid black }
    .editlink { font-size: 8pt }
    .userpanel { background: #c7bce8 }
    img { border: none }
    .deps { margin-left: 2cm }
  </style>

  <script>
    // CodeCatalog Snippet http://www.codecatalog.net/16/119/
    var elt = function(name, attrs) {
        var r = $(document.createElement(name));
        if (attrs) {
            for (var i in attrs) {
                r.attr(i, attrs[i]);
            }
        }
        for (var i = 2; i < arguments.length; ++i) {
            r.append(arguments[i]);
        }
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/87/231/
    var dropdown = function(clicker, make_elements) {
        var div = elt('div', {}, clicker);
        var onclick = function() {
            var list = elt('table');
            div.append(list);
            clicker.unbind('click');
            clicker.click(function() {
                clicker.unbind('click');
                list.remove();
                clicker.click(onclick);
                return false;
            });
    
            make_elements(function(e) {
                list.append(elt('tr', {}, elt('td', {}, e)));
            });
        };
        clicker.click(onclick);
        return div;
    };
    // End CodeCatalog Snippet

    $(function() {
{% if user.is_authenticated %}
        $.get('/api/user/events/check/', function (hasEvents) {
            if (!hasEvents) return;
            $('#events').append(
                dropdown(elt('a', { href:'#' }).addClass('new_events').text("New Events"), function(adder) {
                    $.get('/api/user/events/new/', function (events) {
                        events.forEach(function(e) {
                            var link = elt('a', { href: '#' }).text(e.name);
                            var mklink = function(tvptr) {
                                link.click(function() {
                                    $.post('/api/user/events/mark_viewed/',
                                        { versionptr: e.versionptr },
                                        function () { window.location.href = '/' + tvptr + '/' });
                                    return false;
                                });
                                return link;
                            };
                            if (e.type == 'new_version') {
                                if (e.versionptr_type == 'Spec' || e.versionptr_type == 'Snippet') {
                                    adder(elt('p').text('New version of ').append(mklink(e.versionptr)));
                                }
                                else if (e.versionptr_type == 'BugReport') {
                                    adder(elt('p').text('Bug activity on ').append(link));
                                    $.get('/api/bug/' + e.version + '/', function(r) {
                                        mklink(r.target_versionptr);
                                    });
                                }
                            }
                            else if (e.type == 'bug') {
                                adder(elt('p').text('Bug report: "' + e.bug_title + '" on ').append(mklink(e.versionptr)));
                            }
                            else if (e.type == 'vote' && e.value > 0) {
                                adder(elt('p').text('Upvote on ').append(mklink(e.versionptr)));
                            }
                            else if (e.type == 'vote' && e.value < 0) {
                                adder(elt('p').text('Downvote on ').append(mklink(e.versionptr)));
                            }
                        });
                    });
                }).addClass('events_table')
            );
        });
{% endif %}

        $('#loginoutbutton').click(function() {
            var path = window.location.pathname;
            window.location.href = $('#loginoutbutton').attr('href') + "?next=" + escape(path);
            return false;
        });
    });
  </script>
  <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-22481725-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

  </script>
 </head>
 <body>
  <div class="site">
   <div class="userpanel">
    <table width="100%">
     <tr>
      <td>
       {% if user.is_authenticated %}
        <b><a href="/profile/">{{user.username}}</a></b> (<a href="/logout/" name="loginoutbutton" id="loginoutbutton">logout</a>)
       {% else %}
        <a href="/openid/login/" name="loginoutbutton" id="loginoutbutton">login</a>
       {% endif %}
      </td> 
      <td><a href="/faq/">FAQ</a></td>
      <td>
       {% if user.is_authenticated %}
        <div id="events"></div>
       {% endif %}
      </td>
      <td style="text-align: right">
       <a href="/search/">New / Search</a>
     </tr>
    </table>
   </div>
   <div class="centered">
    <a href="/"><img src="/static/banner.png" /></a>
   </div>
   {% block content %}
   {% endblock %}
  </div>

  <script type="text/javascript">
  var uservoiceOptions = {
    /* required */
    key: 'codecatalog',
    host: 'codecatalog.uservoice.com', 
    forum: '110735',
    showTab: true,  
    /* optional */
    alignment: 'right',
    background_color:'#66C', 
    text_color: 'white',
    hover_color: '#66C',
    lang: 'en'
  };
  
  function _loadUserVoice() {
    var s = document.createElement('script');
    s.setAttribute('type', 'text/javascript');
    s.setAttribute('src', ("https:" == document.location.protocol ? "https://" : "http://") + "cdn.uservoice.com/javascripts/widgets/tab.js");
    document.getElementsByTagName('head')[0].appendChild(s);
  }
  _loadSuper = window.onload;
  window.onload = (typeof window.onload != 'function') ? _loadUserVoice : function() { _loadSuper(); _loadUserVoice(); };
  </script>
 </body>
</html>

