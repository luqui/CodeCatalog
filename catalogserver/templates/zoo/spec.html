{% extends "zoo/frame.html" %}

{% block header %}
  {% include "static/jquery.html" %}

  <script type="text/javascript" src="/static/editable.js"></script>
  <script type="text/javascript" src="/static/select_on_click.js"></script>
  <script type="text/javascript" src="/static/showdown.js"></script>
  <script type="text/javascript" src="/static/editable_markdown.js"></script>

  <style>
   #name { font-family: monospace }
   .hidden { display: none }
   .snippet { background: #eec }
   .canon { background: #aea }
   .languagemark { background: #db9; font-weight: bold; float: right }
  </style>

{% block scripting %}

  <script type="text/javascript">

    // CodeCatalog Snippet http://codecatalog.net/21/
    var reload = function() { document.location.reload(); };
    // End CodeCatalog Snippet

    var post = function(url, dict, callback) {
        dict['csrfmiddlewaretoken'] = '{{csrf_token}}';
        $.post(url, dict, callback);
    };

    var linecomment = {
        python: '#',
        javascript: '//',
    };

    var annotator = function (id) { 
        var lang = $('#code_' + id).attr('language');
        return function (text) {
            return linecomment[lang] + " CodeCatalog Snippet http://codecatalog.net/" + id + "/\n" 
                 + text
                 + linecomment[lang] + " End CodeCatalog Snippet\n";
        };
    };

    var votedown_snip = function (versionptr) {
        post('/api/vote/', { versionptr: versionptr, value: -1 }, reload);
    };

    var voteup_snip = function (versionptr) {
        post('/api/vote/', { versionptr: versionptr, value: 1 }, reload);
    };

    var max = function() {
        var r = arguments[0];
        for (var i = 1; i < arguments.length; ++i) {
            if (arguments[i] > r) r = arguments[i];
        }
        return r;
    };

    var min = function() {
        var r = arguments[0];
        for (var i = 1; i < arguments.length; ++i) {
            if (arguments[i] < r) r = arguments[i];
        }
        return r;
    };

    var savespec = function() {
        post('/api/new/spec/', { 
            'versionptr': {{spec.versionptr}}, 
            'name': $('#name').text(),
            'summary': $('#summary').text(),
            'spec': $('#spec').val()
        });
    };

    $(function() {
        var e = editable({ onedit: function() { savespec(); } });
        e.installEditButtons();
        
        makeMarkdownArea($('#spec'), 'spec', function(text) { 
            savespec();
        });
        
        $('textarea').each(function (i,e) {
            e = $(e);
            if (e.attr('id') == 'spec') return;
            e.attr('rows', min(10, linecount(e.val())));
            select_on_click(e, annotator(e.attr('snipid')));
        });
    });
  </script>
{% endblock scripting %}
{% endblock header %}

{% block content %}

{% block spec %}
<h1><span id="name" name="name" class="editable"><a href="/spec/{{spec.versionptr}}">{% block title %}{{spec.name}}{% endblock %}</a></span></h1>
<h2>Summary</h2>
<span id="summary" name="summary" class="editable">{{spec.summary}}</span>
<h2>Spec</h2>
<textarea id="spec" name="spec" rows="15" cols="72">{{spec.spec}}</textarea>
{% endblock spec %}

{% block impls %}
{% for snip in snippets %}
<table border="0">
 <tr>
  <td>
   <textarea class="snippet"
             snipid="{{snip.version}}" 
             language="{{snip.language}}" 
             name="code_{{snip.version}}" id="code_{{snip.version}}" 
             cols="72" readonly="readonly">{{snip.code}}</textarea><br/>
   <div class="languagemark">{{snip.language}}</div>
  </td>
  <td>
   <table border="0">
    {% if user.is_authenticated %}
    <tr><td><button onclick="votedown_snip({{snip.versionptr}})">-</button> {{snip.votes}} <button onclick="voteup_snip({{snip.versionptr}})">+</button></td></tr>
    {% endif %}
   </table>
  </td>
 </tr>
</table>
{% endfor %}
{% endblock impls %}
{% endblock content %}
