{% extends "zoo/frame.html" %}
{% load json_dump %}

{% block pagetitle %}
{{spec.name}} - CodeCatalog
{% endblock %}

{% block header %}
  
  <script type="text/javascript" src="/static/editable.js"></script>
  <script type="text/javascript" src="/static/showdown.js"></script>
  <script type="text/javascript" src="/static/editable_markdown.js"></script>
  <script type="text/javascript" src="/static/code_editor.js"></script>
  <script type="text/javascript" src="/static/shjs/sh_main.js"></script>
  <script type="text/javascript" src="/static/diff_match_patch.js"></script>
  <link rel="stylesheet" type="text/css" href="/static/shjs/sh_style.css" />

  <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css" />
  <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>

  <style>
    h2 {
        font-size: 14pt;
        display: inline;
    }
    .hidden { display: none; visibility: hidden; width: 10px }
    .data { display: none; visibility: hidden; width: 10px }
    .cc_code, .cc_code textarea { 
    	width: 750px; 
    	background: white; 
    }
    
    .cc_code pre {
    	width: 750px;
    	overflow: auto;
    }
    
    .deps_area { 
        display: block; 
        margin: auto;
        padding-left: 100px;
        padding-right: 100px;
    }
    
    .deps_area table {
        margin: auto;
        border-style: hidden;
        border-collapse: collapse;
        border-spacing: 0px;
        border-width: 0px;
    }
    
    .deps_area td {
        border-color: #e3ddf3;
        border-width: 1px;
        border-style: inset;
        padding: 10px 16px;
    }
    
    .deps_header h2 {
        font-size: 12pt;
        margin-right: 1em;
        font-weight: bold;
    } 
    .deps_header {
        margin: auto;
        text-align: center;
    }

    /* Alert */
    .alert { background: #fd9 }

    /* Documentation */
    .spec_name { font-family: monospace; margin-bottom: 0px }
    .summary { margin-left: 1cm; font-style: italic }
    .spec { 
    	background: #eee; 
    	margin-top: 1cm;
    }
    .spec h1 { font-size: 16pt; text-decoration: underline }
    .spec h2 { font-size: 14pt }
    .spec pre { padding-left: 1cm; background: #ccc }

	.spec_literal {
		white-space: pre-wrap;
		word-wrap: break-word;
	}

    .spec_controls { float: right }
    .spec_history_table { border: 1px solid black; background: #ddf }
    .spec_history_table textarea { background: #eee }

    /* Snippet box */
    .snippet_box textarea { 
        background: #eee;
    }
    .snippet_box {
        margin-top: 1cm;
    }
    
    .tabs .tabstrip { 
    	text-align: right;
    	border-spacing: 0; 
    	border-collapse: collapse; 
    	display: block; 
    }
    .tabs .tab {
    	color: #777;
        background: white;
        padding-right: 1cm;
        border: dotted 1px black;
        border-bottom: none;
        cursor: pointer;
        display: inline-block;
    }
    .tabs .tab.selected {
    	background: white;
    	color: black;
    	border: solid 1px black;
        border-bottom: solid 1px white;
        margin-bottom: -1px;
    }
    .tabs .content {
        background: white;
        border-top: 1px solid black;
        border-left: 1px solid lightgray;
        border-right: 1px solid lightgray;
        border-bottom: 1px solid lightgray;
        padding: 4px;
    }
    .language { 
        font-weight: bold; 
        font-style: italic;
        text-transform: capitalize; 
        float: right;
        padding-right: 10px;
        padding-top: 5px;
        display: block;
        clear: right;
    }
    .infoarea {
        float: right;
    }
    .edit_comment {
    	display: block;
        font-style: italic;
    }
    
    .markdown_edit_div {
    	text-align: right;
    }
    
    .dynamic_link_after_text {
    	margin-left: 1em;
    }
    .dynamic_link, .markdown_edit_div a {
    	color: gray;
    	font-family: serif;
    	font-size: 12pt;
    	font-weight: normal;
    	border: 1px solid lightgray;
    }
    .dynamic_link:hover, .markdown_edit_div a:hover {
    	background: gray;
    	color: white;
    	text-decoration: none;
    }
    
    .history {
    	border-bottom: 1px solid black;
    }
    
    .spec_history {
    	border-bottom: 1px solid black;
    }

    /* Bugs box */
    .bugs { }
    .bugs .open { color: #f66 }
    .bugs .resolved { color: #6a6 }
    .bugs .closed { color: #666 }
    .bugs table, .bugs input, .bugs textarea { width: 100% }
    .bugs textarea { height: 1in }
    .bugs .details, .bugs .editor { border: 1px solid black; background: #feb }
  </style>

{% block scripting %}

  <script type="text/javascript">
    // CodeCatalog Snippet http://www.codecatalog.net/18/45/
    var reload = function() { document.location.reload(); };
    // End CodeCatalog Snippet
    
    // CodeCatalog Snippet http://www.codecatalog.net/30/686/
    var language_to_line_comment_map = {
        python: '#',
        javascript: '//',
        haskell: '--',
        c: '//',
        csharp: '//',
        java: '//', 
        ruby: '#'
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/16/119/
    var elt = function(name, attrs) {
        var r = $(document.createElement(name));
        if (attrs) {
            for (var i in attrs) {
                r.attr(i, attrs[i]);
            }
        }
        for (var i = 2; i < arguments.length; ++i) {
            r.append(arguments[i]);
        }
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/37/99/
    var button = function(text, click) {
        var r = elt('button');
        r.text(text);
        r.click(click);
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://codecatalog.net/270/759/
	var dynamic_link_element = function() {
    	return elt('a', { href: '#'});
	}
	// End CodeCatalog Snippet
    
    // CodeCatalog Snippet http://codecatalog.net/167/761/
	var dynamic_link = function(text, click) {
	    var link_element = dynamic_link_element();
	    var d_link = link_element.text(text);
	    d_link.click(function() { click(); return false; });
	    return d_link;
	};
	// End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/39/669/
    var horizontal = function() {
        var row = elt('tr');
        for (var i = 0; i < arguments.length; ++i) {
            var cell = elt('td', {}, arguments[i]);
            row.append(cell);
        }
        return elt('table', {}, row);
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/41/121/
    var vertical = function() {
        var r = elt('table');
        for (var i = 0; i < arguments.length; ++i) {
            var row = elt('tr', {}, elt('td', {}, arguments[i]));
            r.append(row);
        }
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/260/729/
    var count_lines = function(text) {
        return text.split(/\n/).length;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/49/498/
    var label_table = function(dict) {
        var ret = elt('table');
        for (var i in dict) {
            ret.append(elt('tr', {}, 
                           elt('td', {'width': '1', 'class': 'label'}).text(i),
                           elt('td', {}, dict[i])));
        }
        return ret;
    };
    // End CodeCatalog Snippet
    
    // CodeCatalog Snippet http://www.codecatalog.net/248/692/
    var simple_select = function(options) {
        var ret = elt('select', {});
        for (var i in options) {
            ret.append(elt('option', {}).text(options[i]).val(options[i]));
        }
        return ret;
    };
    // End CodeCatalog Snippet
    
    // CodeCatalog Snippet http://www.codecatalog.net/250/697/
    var lazy_highlight_element = function(prefix, suffix, element, language) {
        if (language in sh_languages) {
            if (sh_languages[language]) {
                sh_highlightElement(element, sh_languages[language]);
            }
        }
        else {
            $.get(prefix + 'sh_' + language + suffix, function(reply) {
                eval(reply);
                sh_highlightElement(element, sh_languages[language]);
            }).error(function() {
                sh_languages[language] = null;
            });
        }
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/252/704/
    var escape_html = function(html) {
        return html.split('&').join('&amp;')
                   .split('<').join('&lt;')
                   .split('>').join('&gt;');
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/181/718/
    var tabs = function(ts) {
        var tabtable = elt('div', { 'class': 'tabstrip' });
        var content = elt('div', { 'class': 'content' });
        var container = elt('div', { 'class': 'tabs' }, tabtable, content); 
        var cur;
    
        for (var i in ts) {
            (function() {
                var t = ts[i];
                var cb = function() {
                    if (!t.contentCache) {
                        if (typeof t.content == "function") {
                            t.contentCache = t.content();
                        }
                        else {
                            t.contentCache = t.content;
                        }
                        content.append(t.contentCache);
                    }
                    if (cur) { 
                        cur.contentCache.hide();
                        cur.tab.show();
                        cur.tab.removeClass('selected');
                    }
                    cur = t;
                    t.contentCache.show();
                    t.tab.addClass('selected');
                };
                t.tab = elt('span', { 'class': 'tab' }).text(t.label);
                t.tab.click(cb);
                tabtable.append(t.tab);
                if (i == 0) cb();
            })();
        }
        
        return container;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/254/713/
    var table_row = function() {
        var tr = elt('tr');
        foreach(arguments, function(arg) {
        	tr.append(elt('td', {}, arg));
        });
        return tr;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/256/715/
    var text_node = function(text) { return document.createTextNode(text) };
    // End CodeCatalog Snippet
    
    // CodeCatalog Snippet http://www.codecatalog.net/258/733/
    var please_copy_me_on_click = function(element, text) {
        var textarea = elt('textarea', {
            'rows': count_lines(text),
            'readonly': 'readonly',
            'wrap': 'off'
        }).val(text);
        
        var div = elt('div', {}, element, textarea);    
        textarea.hide();
    
        div.click(function() {
            element.hide();
            textarea.show();
            textarea.focus();
            textarea.select();
        });
        textarea.blur(function() {
            element.show();
            textarea.hide();
        });
        return div;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/263/740/
    var make_pre = function(text) {
        if ($.browser.msie) {
            return $('<pre>' + escape_html(text) + '</pre>');
        }
        else {
            return $('<pre></pre>').text(text);
        }
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://codecatalog.net/274/771/
	var screen_offset = function(element) {
	    var element_offset = element.offset();
	    var offset_x = element_offset.left - window.pageXOffset;
	    var offset_y = element_offset.top - window.pageYOffset; 
	    return { "left": offset_x, "top": offset_y };
	};
	// End CodeCatalog Snippet
    
    // CodeCatalog Snippet http://codecatalog.net/276/773/
    var preserving_screen_position = function(element, mods) {
        var old_offset = screen_offset(element);
        mods();
        var new_offset = screen_offset(element);
            
        window.scrollBy(new_offset.left - old_offset.left, new_offset.top - old_offset.top);
    };
    // End CodeCatalog Snippet
    
    // CodeCatalog Snippet http://codecatalog.net/272/764/
    var toggle_element = function(click_widget, text, text_alt, element, element_alt) {
        var div = elt('div', {}, element);
        if (typeof(element_alt) !== 'function') {
            div.append(element_alt);
            element_alt.hide();
        }
        
        var state = 'normal';
        click_widget.text(text);
        click_widget.click(function() {
            if (state == 'normal') {
            	if (typeof(element_alt) === 'function') {
                    element_alt = element_alt();
                    div.append(element_alt);
                    element_alt.hide();
                }
                
            	preserving_screen_position(click_widget, function() {
	                element_alt.show();
	                element.hide();
	                click_widget.text(text_alt);
            	});

                state = 'alternate';
            }
            else {
            	preserving_screen_position(click_widget, function() {
	            	element.show();
	                element_alt.hide();
	                click_widget.text(text);
            	});
            
                state = 'normal';
            }
            return false;
        });
        return [div, click_widget];
    };
    // End CodeCatalog Snippet
    
	// CodeCatalog Snippet http://codecatalog.net/265/766/
	var toggle_button = function(text, text_alt, element, element_alt) {
	    return toggle_element(elt('button'), text, text_alt, element, element_alt);
	};
	// End CodeCatalog Snippet

    var logged_in = '{{user.is_authenticated}}' == 'True';

    var orm_request = function(req, cb) {
        return $.get('/api/orm/', {request: JSON.stringify(req)}, cb);
    };

    var post = function(url, dict, callback) {
        dict['csrfmiddlewaretoken'] = '{{csrf_token}}';
        $.post(url, dict, callback);
    };

    var annotator = function (snip) { 
        return function (text) {
            return language_to_line_comment_map[snip.language] + " CodeCatalog Snippet http://codecatalog.net/" + snip.versionptr + "/" + snip.serial + "/\n" 
                 + text
                 + language_to_line_comment_map[snip.language] + " End CodeCatalog Snippet\n";
        };
    };

    var savespec = function(cont, comment) {
        post('/api/new/spec/', { 
            'versionptr': {{spec.versionptr}}, 
            'name': $('#name').text(),
            'summary': $('#summary').text(),
            'spec': $('#spec').val(),
            'status': $('#spec_status').val(),
            'comment': comment},
        	function(r) {
            	if (cont) cont();
        	});
    };

    // CodeCatalog Snippet http://codecatalog.net/279/782/
    var foreach = function(array, body) {
        for (var i = 0; i < array.length; ++i) {
            body(array[i]);
        }
    };
    // End CodeCatalog Snippet
    
    var dependencies_area = function(snip) {
        if (snip.dependencies.length == 0) {
            return $([]);
        }
        
        var table = elt('table');
        foreach(snip.dependencies, function (dep) {
            orm_request({ 
                model: 'Spec', 
                query: { 
                    type: 'and', values: [
                        { 
                            type: 'relation', 
                            field: [ 'version', 'versionptr', 'id' ], 
                            relation: 'exact',
                            value: dep 
                        }, { 
                            type: 'relation',
                            field: [ 'version', 'active' ],
                            relation: 'exact',
                            value: true 
                        }
                    ]
                },
                count: 1
            }, function(results) {
                var result = results[0];
                table.append(
                	table_row(
                        elt('a', { href: '/' + result.versionptr + '/' }, text_node(result.name)),
                        text_node(result.summary)));
            });
        });
        return table;
    };

    var assemble = function(snips) {
        var str = "";
        for (var i in snips) {
            str += snips[i].code + "\n";
        }
        return str;
    };
    
    var assemble_and_tag = function(snips) {
        var str = "";
        for (var i in snips) {
            str += annotator(snips[i])(snips[i].code) + "\n";
        }
        return str;
    };

    var highlighted_code_pre = function(code, tagged_code, language) {
        var pre = make_pre(code).addClass('cc_code');
        lazy_highlight_element('/static/shjs/lang/', '.min.js', pre[0], language);

        return please_copy_me_on_click(pre, tagged_code);
    };

    var display_snip_version = function(snip) {
        var pre = highlighted_code_pre(snip.code, annotator(snip)(snip.code), snip.language).addClass('cc_code');
        if (snip.dependencies.length == 0) {
            var area = pre;
            var btn = $([]);
            var deps_area = btn;
        }
        else {
        	var d_link_element = dynamic_link_element();
        	d_link_element.addClass('dynamic_link');
            var toggle = toggle_element(
            		        d_link_element,
                            "expand all", 
                            "collapse",
                            pre,
                            function() {
                                var snips;
                                // TODO make async
                                $.ajax({
                                    url: '/api/snippet/' + snip.version + '/assemble/',
                                    async: false,
                                    success: function(result) { snips = result }
                                });
                                if (!snips) {
                                    alert("Couldn't expand dependencies.  Possibly because of a circular " +
                                          "dependency, or dependency on a spec with no implementations in " + snip.language);
                                    return pre;
                                }
                                var code = assemble(snips);
                                var code_tagged = assemble_and_tag(snips);
                                return highlighted_code_pre(code, code_tagged, snip.language).addClass('cc_code');
                            });
            var area = toggle[0];
            var btn = toggle[1];
            var deps_header = 
            	elt('div', { 'class': 'deps_header' }, 
            		elt('span', {},
            		  elt('h2', { 'class': 'deps_header' }).text("Dependencies"),
            		  btn));
            var deps_area = elt('hr')
                    .add(deps_header)
                    .add(elt('div', {}, dependencies_area(snip)).addClass('deps_area'));
        }

        return elt('span', {'class': 'language'}).text(snip.language)
                 .add(area)
                 .add(deps_area);
    };

    var diff_to_pretty_html = function(diffs, language) 
    {
		var html = [];
		var i = 0;
		var pattern_amp = /&/g;
		var pattern_lt = /</g;
		var pattern_gt = />/g;
		for (var x = 0; x < diffs.length; x++) {
		var op = diffs[x][0];    // Operation (insert, delete, equal)
			var data = diffs[x][1];  // Text of change.
			var text = data.replace(pattern_amp, '&amp;').replace(pattern_lt, '&lt;')
			    .replace(pattern_gt, '&gt;');
			switch (op) {
				case DIFF_INSERT:
				  html[x] = '<ins style="background:#e6ffe6;">' + text + '</ins>';
				  break;
				case DIFF_DELETE:
				  html[x] = '<del style="background:#ffe6e6;">' + text + '</del>';
				  break;
				case DIFF_EQUAL:
				  html[x] = '<span>' + truncate_unchanged_from_diff(3, text, language) + '</span>';
				  break;
			}
			if (op !== DIFF_DELETE) {
				i += data.length;
			}
  	  	}
  		return html.join('');
  	};
    	
    var truncate_unchanged_from_diff = function(context_lines, str, language) {
    	var lines = str.split("\n");
    	if (lines.length > 2*context_lines+4) {
    		var line_comment = language in language_to_line_comment_map 
    								? language_to_line_comment_map[language]
    								: '';
    							
    		return lines.slice(0,context_lines).concat(
    				["\n" + line_comment + " ---- " + (lines.length - 2*context_lines) + " lines omitted ----\n"],
    				lines.slice(lines.length-context_lines, lines.length))
    			.join("\n");
    	}
    	else {
    		return str;
    	}
    };
    
    // CodeCatalog Snippet http://codecatalog.net/267/751/
   	var iterate_adjacent = function(array, deflt, func) {
   	    for (var i = 0; i < array.length; ++i) {
   		var current = array[i];
   	    	var next = i + 1 < array.length ? array[i+1] : deflt;
   	    	func(current, next);
   	    }
   	};
   	// End CodeCatalog Snippet
    
   	// CodeCatalog Snippet http://codecatalog.net/294/1/
	var timestamp_to_string = function(timestamp) {
	   var date_time = timestamp.split('T');
	   var date = date_time[0];
	   var time = date_time[1].split('.')[0];
	   return time + ", " + date;
	};
	// End CodeCatalog Snippet

   	var render_diff = function(dmp, text_a, text_b, language) {
    	var diffs = dmp.diff_main(text_a, text_b);
        dmp.diff_cleanupSemantic(diffs);
        return diff_to_pretty_html(diffs, language);
    };
    
    var wrap_in_pre = function(element) {
    	if ($.browser.msie)
    		return $('<pre>' + element + '</pre>');
    	else
    		return elt('pre', {}, element);
    };
    
    var display_snips_history = function(snips) {
        var table = elt('div');
        var dmp = new diff_match_patch();
        iterate_adjacent(snips, {'code':''}, function(snip, prev_snip) {
            var info;
            if (snip.active || !logged_in) {
                info = $([]);
            }
            else {
                info = dynamic_link('Revert to this version', function() {
                    var newsnip = $.extend({}, snip);
                    newsnip.dependencies = snip.dependencies.join(',');
                    newsnip.comment = "Revert to version " + snip.versionptr + "/" + snip.serial;
                    delete newsnip.version;
                    delete newsnip.serial;
                    $.post('/api/new/snippet/', newsnip, reload);
                });
            }
            var comment;
            if (snip.comment) {
                comment = elt('span').text(snip.comment);
            }
            else {
                comment = elt('span').text("<No comment>");
            }
            
            var history_annotation = " -- by " + snip.user + " at " + timestamp_to_string(snip.timestamp);
            var diff_html = $(wrap_in_pre(render_diff(dmp, prev_snip.code, snip.code, snip.language)));
            lazy_highlight_element('/static/shjs/lang/', '.min.js', diff_html[0], snip.language);
            var d = elt('div', { 'class': 'history cc_code'}, 
            			diff_html.add(elt('span', { 'class': 'edit_comment' }, 
            				    comment, elt('span').text(history_annotation)))
            				.add(info));
            table.append(d);
        });
        return table;
    };

    var display_snip_history = function(snip) {
        var div = elt('div');
        orm_request({
            model: 'Snippet',
            query: {
                type: 'relation',
                field: [ 'version', 'versionptr', 'id' ],
                relation: 'exact',
                value: snip.versionptr
            }
        }, function(snips) {
            snips.sort(function(a,b) {
                return a.timestamp < b.timestamp ? 1 : -1;
            });
            div.append(display_snips_history(snips));
        });
        return div;
    };

    var display_spec_version = function(title, summary, spec) {
    	return $([])
       		.add(elt('h1', {'class': 'spec_name'}, title))
   			.add(elt('span', {'class':'summary'}, summary))
    		.add(wrap_in_pre(spec).addClass('spec').addClass('spec_literal'));
    };
    
    var display_specs_history = function(specs) {
        var table = elt('div');
        var dmp = new diff_match_patch();
        iterate_adjacent(specs, {'name': '', 'summary': '', 'spec': ''}, function(spec, prev_spec) {
	        var info;
	        if (spec.active || !logged_in) {
	            info = $('');
	        }
        	else {
            	info = dynamic_link('Revert to this version', function() {
                	var newspec = $.extend({}, spec);
                	newspec.comment = "Revert to version " + spec.versionptr + "/" + spec.serial;
                	delete newspec.version;
                    delete newspec.serial;
                	$.post('/api/new/spec/', newspec, reload);
            	});
        	}
	        if (spec.status == 'Deprecated') {
                info = vertical(elt('b').text('DEPRECATED'), info);
            }
	        
	        var comment;
	        if (spec.comment) {
	            comment = elt('span').text(spec.comment);
	        }
	        else {
	            comment = elt('span').text("<No comment>");
	        }
	        
	        var diff_title = render_diff(dmp, prev_spec.name, spec.name, null);
	        var diff_summary = render_diff(dmp, prev_spec.summary, spec.summary, null);
	        var diff_spec = render_diff(dmp, prev_spec.spec, spec.spec, 'markdown');
        	var spec_display = display_spec_version(diff_title, diff_summary, diff_spec);
        	
	        var d = spec_display.add(elt('span', {'class':'edit_comment'}, comment, elt('span').text('-- by ' + spec.user)))
	                            .add(info);
	        table.append(elt('div', {'class': 'spec_history'}, d));
	    });
	    
        return table;
    };

    var display_spec_history = function(spec) {
        var div = elt('div');
        orm_request({
            model: 'Spec',
            query: {
                type: 'relation',
                field: [ 'version', 'versionptr', 'id' ],
                relation: 'exact',
                value: spec.versionptr
            }
        }, function(specs) {
            specs.sort(function(a,b) {
                return a.timestamp < b.timestamp ? 1 : -1;
            });
            div.append(display_specs_history(specs));
        });
        return div;
    };

    var display_snip_container = function(snip) {
        return tabs([
            { label: 'Active', content: function() { return display_snip_versionptr(snip) } },
            { label: 'History', content: function() { return display_snip_history(snip) } }
            ]).addClass('snippet_box');
    };

    var display_snip_versionptr = function(snip) {
        var edit = function() {
            if (!try_login()) return;
            editlink.remove();
            version_display.replaceWith(code_editor(snip, function(newsnip) {
                $.post('/api/new/snippet/', newsnip, reload);
            }));
        };

        var version_display = display_snip_version(snip);
        var editlink = dynamic_link("edit", edit).addClass('dynamic_link');

        return version_display.add(editlink);
    };

    var render_bug = function(bug) {
        var details = elt('a', {href:'#'}).text("Details...");
        var cls = 
            bug.status == 'Open'     ? 'open' :
            bug.status == 'Resolved' ? 'resolved' :
            bug.status == 'Closed'   ? 'closed'
                                     : 'unknown';
        var ret = elt('div', {'class': cls},
            elt('p').text(bug.title).append(
                elt('b').text(" -- " + bug.status + ". "),
                details));
        details.click(function() {
            ret.replaceWith(render_bug_details(bug));
            return false;
        });
        return ret; 
    };

    var render_bug_details = function(bug) {
        var div = elt('div').addClass("details");
        orm_request({
            model: 'BugReport',
            query: {
                type: 'relation',
                field: [ 'version', 'versionptr', 'id' ],
                relation: 'exact',
                value: bug.versionptr
            }
        }, function(bugs) {
            for (var i in bugs) {
                div.append(render_bug_version(bugs[i]));
            }
            var link = button('Update', function() {
                var last = bugs[bugs.length-1];
                link.replaceWith(bug_edit_box(last.target_versionptr, last, render_bug_version));
            });
            div.append(link);
            div.append(button('Hide', function() { div.replaceWith(render_bug(bug)) }));
        });
        return div;
    };

    var render_bug_version = function(bug) {
        return elt('div', {}, 
            horizontal(elt('b').text(bug.title), elt('span').text(bug.user || 'Anonymous'), elt('span').text(bug.status)),
            elt('p').text(bug.comment));
    };

    var bug_edit_box = function(target, bug, cont) {
        var newdiv = elt('div', { 'class': 'editor' });
        var input = elt('input', { type: 'text' }).val(bug.title);
        var textarea = elt('textarea');
        var select = simple_select([ 'Open', 'Resolved', 'Closed' ]);
        select.val(bug.status || 'Open');
        
        var btn = button('OK', function() {
            var newbug = { target_versionptr: target, title: input.val(), comment: textarea.val(), status: select.val(), user: '{{user.username}}' };
            if (bug.versionptr) { newbug['versionptr'] = bug.versionptr; }
            
            post('/api/new/bug/', newbug, function(r) {
                newbug.version = r.version;
                newbug.serial = r.serial;
                newbug.versionptr = r.versionptr;
            });
            
            newdiv.replaceWith(cont(newbug));
        });
        var cancelbtn = button('Cancel', function() { newdiv.remove() });
        newdiv.append(label_table({
                'Bug Title': input,
                'Status': select,
                'Details/Comment': textarea}),
            btn, cancelbtn);
        return newdiv;
    };

    var bugs_box = function(versionptr) {
        var div = elt('div', { 'class': 'bugs' });

        var newbug = elt('a', { 'href': '#', 'class': 'dynamic_link' }).text("report bug");
        newbug.click(function() {
            newbug.before(bug_edit_box(versionptr, {}, render_bug));
            return false;
        });
        div.append(newbug);
        
        orm_request({
            model: 'BugReport',
            query: {
                type: 'and',
                values: [
                    {
                        type: 'relation',
                        field: ['target_versionptr', 'id'],
                        relation: 'exact',
                        value: versionptr
                    },
                    {
                        type: 'relation',
                        field: ['version', 'active'],
                        relation: 'exact',
                        value: true
                    }
                ]
            }
        }, function(bugs) {
            for (var i in bugs) {
                div.prepend(render_bug(bugs[i]));
            }
        });
        return div;
    };

    var try_login = function() {
        if (logged_in) {
            return true;
        }
        else {
            var path = window.location.pathname;
            window.location.href = '/openid/login/?next=' + escape(path);
            return false;
        }
    };

    $(function() {
        editable({ 
                onedit: function() { savespec(); },
                custom_on_click: try_login})
            .installEditButtons();
        
        makeMarkdownArea($('#spec'), 'spec', function(text, comment) { 
            savespec(null, comment);
        }, try_login);

        var history_handler = function () {
            var region = $('#spec_region');
            region.hide();
            var history = display_spec_history(JSON.parse($('#spec_data').val()));
            var hidebutton = elt('a', {'class':'dynamic_link', 'href':'#'}).text('hide history');
            history.prepend(elt('div', {'class':'spec_controls'}, hidebutton));
            region.after(history);

            $('#spec_history').unbind('click', history_handler);
            hidebutton.click(function() {
                history.hide();
                region.show();
            });
            $('#spec_history').click(function() {
                region.hide();
                history.show();
            });

            return false;
        };
        $('#spec_history').click(history_handler);

        $('#spec_bugs').append(bugs_box({{spec.versionptr}}));

        $('.snippet').each(function (i,e) {
            e = $(e);
            var data = JSON.parse(e.find('.data').text());
            var snip = display_snip_container(data);
            e.replaceWith(snip);
            snip.after(bugs_box(data.versionptr));
        });

        $('#addsnippet').click(function() {
            var proto = {
                spec_versionptr: {{spec.versionptr}}};
            $('#addsnippet').replaceWith(code_editor(proto, function(newsnip) {
                $.post('/api/new/snippet/', newsnip, reload);
            }));
        });

        var spec_status = $('#spec_status');
        if (spec_status.length) {
            spec_status.change(function() {
                var s = spec_status.val();
                if (s != "{{spec.status}}") {
                    if (confirm("Are you sure you want to mark this spec as " + s + "?")) {
                        savespec(reload);
                    }
                    else {
                        spec_status.val("{{spec.status}}");
                    }
                }
            });
        }
    });
  </script>
{% endblock scripting %}
{% endblock header %}

{% block content %}

{% block alert %}
 {% if spec.status == 'Deprecated' %} 
  <div class="alert">
  This spec is <b>Deprecated</b>.  Typically this means that there is a strictly better 
  alternative that is documented on this page.
  </div>
 {% endif %}
{% endblock %}

{% block spec %}
<div id="spec_region">
 <div class="spec_controls">
   <div>
    <a id="spec_history" name="spec_history" class="dynamic_link" href="#">history</a>
   </div>
   {% if user.is_authenticated %}
   <div>
    <select id="spec_status" name="spec_status">
     <option value="Open" {%if spec.status == 'Open' %}selected{%endif%}>Open</option>
     <option value="Deprecated" {%if spec.status == 'Deprecated' %}selected{%endif%}>Deprecated</option>
    </select>
   </div>
   {% endif %}
 </div>
 <h1 class="spec_name"><span id="name" name="name" class="editable">{% block title %}{{spec.name}}{% endblock %}</span></h1>
 <span id="summary" name="summary" class="summary editable">{{spec.summary}}</span>
 <textarea id="spec" name="spec" rows="30" class="cc_code">{{spec.spec}}</textarea>
 <textarea id="spec_data" name="spec_data" class="hidden" readonly="readonly">{{spec|json}}</textarea>
</div>
<div id="spec_bugs"></div>
{% endblock spec %}

{% block impls %}
{% for snip in snippets %}
<div class="snippet">
 <pre class="code" readonly="readonly">{{snip.code}}</pre>
 <pre class="data hidden" readonly="readonly">{{snip|json}}</pre>
</div>
{% endfor %}

<div class="iecentered">
  <div style="margin: auto">
	<a href='#' name="addsnippet" class="dynamic_link" id="addsnippet">add snippet</a>
  </div>
</div>
{% endblock impls %}
{% endblock content %}
