{% extends "zoo/frame.html" %}
{% load json_dump %}

{% block header %}
  
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>

  <script type="text/javascript" src="/static/editable.js"></script>
  <script type="text/javascript" src="/static/select_on_click.js"></script>
  <script type="text/javascript" src="/static/showdown.js"></script>
  <script type="text/javascript" src="/static/editable_markdown.js"></script>
  <script type="text/javascript" src="/static/code_editor.js"></script>

  <style>
    #name { font-family: monospace }
    .hidden { display: none; visibility: hidden; width: 10px }
    #hack { display: none; visibility: hidden; width: 10px }
    .snippet { background: #ddb; margin-top: 5mm }
    .snippet > table { width: 100% }
    .snippet textarea { background: #eee; width: 100% }
    .languagemark { background: #db9; font-weight: bold }
    .depmark { background: #db9; float: left }
    .bugs_box { margin-left: 1in }
    .bug_summary { color: #666 }
    .bugs_box table,input,textarea { width: 100% }
    .bugs_box textarea { height: 1in }
    .bug_details { border: 1px solid black; background: #fd9 }
  </style>

{% block scripting %}

  <script type="text/javascript">

    var logged_in = '{{user.is_authenticated}}' == 'True';

    // CodeCatalog Snippet http://codecatalog.net/45/
    var reload = function() { document.location.reload(); };
    // End CodeCatalog Snippet

    var post = function(url, dict, callback) {
        dict['csrfmiddlewaretoken'] = '{{csrf_token}}';
        $.post(url, dict, callback);
    };

    // CodeCatalog Snippet http://codecatalog.net/79/
    var linecomment = {
        python: '#',
        javascript: '//',
    };
    // End CodeCatalog Snippet

    var annotator = function (snip) { 
        return function (text) {
            return linecomment[snip.language] + " CodeCatalog Snippet http://codecatalog.net/" + snip.version + "/\n" 
                 + text
                 + linecomment[snip.language] + " End CodeCatalog Snippet\n";
        };
    };

    var votedown_snip = function (versionptr) {
        post('/api/vote/', { versionptr: versionptr, value: -1 }, reload);
    };

    var voteup_snip = function (versionptr) {
        post('/api/vote/', { versionptr: versionptr, value: 1 }, reload);
    };

    // CodeCatalog Snippet http://codecatalog.net/85/
    var max = function() {
        var r = arguments[0];
        for (var i = 1; i < arguments.length; ++i) {
            if (arguments[i] > r) r = arguments[i];
        }
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://codecatalog.net/96/
    var min = function() {
        var r = arguments[0];
        for (var i = 1; i < arguments.length; ++i) {
            if (arguments[i] < r) r = arguments[i];
        }
        return r;
    };
    // End CodeCatalog Snippet

    var savespec = function() {
        post('/api/new/spec/', { 
            'versionptr': {{spec.versionptr}}, 
            'name': $('#name').text(),
            'summary': $('#summary').text(),
            'spec': $('#spec').val()
        });
    };

    // CodeCatalog Snippet http://codecatalog.net/119/
    var elt = function(name, attrs) {
        var r = $(document.createElement(name));
        if (attrs) {
            for (var i in attrs) {
                r.attr(i, attrs[i]);
            }
        }
        for (var i = 2; i < arguments.length; ++i) {
            r.append(arguments[i]);
        }
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://codecatalog.net/99/
    var button = function(text, click) {
        var r = elt('button');
        r.text(text);
        r.click(click);
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://codecatalog.net/120/
    var horizontal = function() {
        var row = elt('tr');
        for (var i = 0; i < arguments.length; ++i) {
            var cell = elt('td', {}, arguments[i]);
            row.append(cell);
        }
        return elt('table', {}, row);
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://codecatalog.net/121/
    var vertical = function() {
        var r = elt('table');
        for (var i = 0; i < arguments.length; ++i) {
            var row = elt('tr', {}, elt('td', {}, arguments[i]));
            r.append(row);
        }
        return r;
    };
    // End CodeCatalog Snippet

    var dependencies_area = function(snip) {
        if (snip.dependencies.length == 0) {
            return $('');
        }
        
        var b = button('Depends...', function() {
            var table = elt('table');
            snip.dependencies.forEach(function (dep) {
                $.get('/api/specs/' + dep + '/active/', function (result) {
                    table.append(
                        elt('tr', {}, 
                            elt('td', {},
                                elt('a', { href: '/spec/' + result.versionptr + '/' })
                                    .text(result.name)),
                            elt('td', {}).text(result.summary)));
                });
            });
            b.replaceWith(table);
        });
        return b;
    };

    var displaysnip = function(snip) {
        var div = elt('div', { class: 'snippet' });

        var textarea = elt('textarea', { rows: 30, cols: 72, readonly: 'readonly' });
        textarea.val(snip.code);
        textarea.attr('rows', linecount(snip.code));

        select_on_click(textarea, annotator(snip));

        var votesbox = elt('span');
        votesbox.text(snip.votes);

        var edit = function() {
            div.replaceWith(code_editor(snip, function(newsnip) {
                $.post('/api/new/snippet/', newsnip, reload);
            }));
        };

        var infoarea = 
            vertical(
                $('<span class="languagemark"></span>').text(snip.language),
                horizontal(
                    button('-', function() { votedown_snip(snip.versionptr) }),
                    votesbox,
                    button('+', function() { voteup_snip(snip.versionptr) })),
                button("edit", edit),
                dependencies_area(snip));

        var table = horizontal(textarea, infoarea);

        div.append(table);
        return div;
    };

    var render_bug = function(bug) {
        var details = elt('a', {href:'#'}).text("Details...");
        var ret = elt('div', {},
            elt('p').text(bug.title).append(
                elt('b').text(" -- " + bug.status + ". "),
                details)).addClass("bug_summary");
        details.click(function() {
            ret.replaceWith(render_bug_details(bug));
            return false;
        });
        return ret; 
    };

    var render_bug_details = function(bug) {
        var div = elt('div').addClass("bug_details");
        $.get('/api/bugs/' + bug.versionptr + '/all/', function(bugs) {
            for (var i in bugs) {
                div.append(render_bug_version(bugs[i]));
            }
            var link = button('Update', function() {
                var last = bugs[bugs.length-1];
                link.replaceWith(bug_edit_box(last.target_versionptr, last, render_bug_version));
            });
            div.append(link);
            div.append(button('Hide', function() { div.replaceWith(render_bug(bug)) }));
        });
        return div;
    };

    var render_bug_version = function(bug) {
        return elt('div', {}, 
            horizontal(elt('b').text(bug.title), elt('span').text(bug.user), elt('span').text(bug.status)),
            elt('p').text(bug.comment));
    };

    // CodeCatalog Snippet http://codecatalog.net/149/
    var label_table = function(dict) {
        var ret = elt('table');
        for (var i in dict) {
            ret.append(elt('tr', {}, 
                           elt('td', {}).text(i),
                           elt('td', {}, dict[i])));
        }
        return ret;
    };
    // End CodeCatalog Snippet

    var simple_select = function(options) {
        var ret = elt('select', {});
        for (var i in options) {
            ret.append(elt('option', {}).text(options[i]).val(options[i]));
        }
        return ret;
    };

    var bug_edit_box = function(target, bug, cont) {
        var newdiv = elt('div');
        var input = elt('input', { type: 'text' }).val(bug.title);
        var textarea = elt('textarea');
        var select = simple_select([ 'Open', 'Resolved', 'Closed' ]);
        select.val(bug.status || 'Open');
        
        var btn = button('OK', function() {
            var newbug = { target_versionptr: target, title: input.val(), comment: textarea.val(), status: select.val(), user: '{{user.username}}' };
            if (bug.versionptr) { newbug['versionptr'] = bug.versionptr; }
            
            post('/api/new/bug/', newbug, function(r) {
                newbug.version = r.version;
                newbug.versionptr = r.versionptr;
            });
            
            newdiv.replaceWith(cont(newbug));
        });
        newdiv.append(label_table({
                Title: input,
                Status: select,
                Details: textarea}),
            btn);
        return newdiv;
    };

    var bugs_box = function(versionptr) {
        var div = elt('div', { 'class': 'bugs_box' });

        if (logged_in) {
            var newbug = elt('a', { href: '#' }).text("Report Bug");
            newbug.click(function() {
                newbug.before(bug_edit_box(versionptr, {}, render_bug));
                return false;
            });
            div.append(newbug);
        }
        
        $.get('/api/specs/' + versionptr + '/bugs/active/', function(bugs) {
            for (var i in bugs) {
                div.prepend(render_bug(bugs[i]));
            }
        });
        return div;
    };

    $(function() {
        var e = editable({ onedit: function() { savespec(); } });
        e.installEditButtons();
        
        makeMarkdownArea($('#spec'), 'spec', function(text) { 
            savespec();
        });

        $('#spec_bugs').append(bugs_box({{spec.versionptr}}));

        $('.snippet').each(function (i,e) {
            e = $(e);
            var data = JSON.parse(e.find('.data').val());
            var snip = displaysnip(data);
            e.replaceWith(snip);
            snip.after(bugs_box(data.versionptr));
        });
    });
  </script>
{% endblock scripting %}
{% endblock header %}

{% block content %}

{% block spec %}
<h1><span id="name" name="name" class="editable"><a href="/spec/{{spec.versionptr}}">{% block title %}{{spec.name}}{% endblock %}</a></span></h1>
<h2>Summary</h2>
<span id="summary" name="summary" class="editable">{{spec.summary}}</span>
<h2>Spec</h2>
<textarea id="spec" name="spec" rows="15" cols="72">{{spec.spec}}</textarea>
<div id="spec_bugs"></div>
{% endblock spec %}

{% block impls %}
{% for snip in snippets %}
<div class="snippet">
 <textarea class="code" readonly="readonly">{{snip.code}}</textarea>
 <textarea id="hack" class="data hidden" readonly="readonly">{{snip|json}}</textarea>
</div>

{% endfor %}
{% endblock impls %}
{% endblock content %}
