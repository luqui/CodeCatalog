{% extends "zoo/frame.html" %}
{% load json_dump %}

{% block header %}
  
  <script type="text/javascript" src="/static/editable.js"></script>
  <script type="text/javascript" src="/static/select_on_click.js"></script>
  <script type="text/javascript" src="/static/showdown.js"></script>
  <script type="text/javascript" src="/static/editable_markdown.js"></script>
  <script type="text/javascript" src="/static/code_editor.js"></script>

  <style>
    .hidden { display: none; visibility: hidden; width: 10px }
    .data { display: none; visibility: hidden; width: 10px }
    .cc_code { width: 750px }

    /* Alert */
    .alert { background: #fd9 }

    /* Documentation */
    .spec_name { font-family: monospace; margin-bottom: 0px }
    .summary { margin-left: 1cm; font-style: italic }
    .spec { background: #eee; margin-top: 1cm }
    .spec h1 { font-size: 16pt; text-decoration: underline }
    .spec h2 { font-size: 14pt }
    .spec pre { padding-left: 1cm; background: #ccc }

    /* Snippet box */
    .snippet_box textarea { 
        background: #eee;
    }
    .snippet_box {
        margin-top: 1cm;
    }
    
    .tabs .tabstrip { border-spacing: 0; border-collapse: collapse; }
    .tabs .tab { 
        background: #bb9;
        padding-bottom: 0px;
        padding-right: 1cm;
        border: 1px solid black;
        border-bottom: none;
        cursor: pointer;
    }
    .tabs .selected {
        background: #ddb;
    }
    .tabs .content {
        background: #ddb;
    }
    .language { background: #db9; font-weight: bold }

    /* Bugs box */
    .bugs { margin-left: 1in }
    .bugs .open { color: #f66 }
    .bugs .resolved { color: #6a6 }
    .bugs .closed { color: #666 }
    .bugs table,input,textarea { width: 100% }
    .bugs textarea { height: 1in }
    .bugs .details, .bugs .editor { border: 1px solid black; background: #feb }
  </style>

{% block scripting %}

  <script type="text/javascript">

    var logged_in = '{{user.is_authenticated}}' == 'True';

    // CodeCatalog Snippet http://www.codecatalog.net/18/45/
    var reload = function() { document.location.reload(); };
    // End CodeCatalog Snippet
    var post = function(url, dict, callback) {
        dict['csrfmiddlewaretoken'] = '{{csrf_token}}';
        $.post(url, dict, callback);
    };

    // CodeCatalog Snippet http://www.codecatalog.net/30/79/
    var linecomment = {
        python: '#',
        javascript: '//',
    };
    // End CodeCatalog Snippet
    var annotator = function (snip) { 
        return function (text) {
            return linecomment[snip.language] + " CodeCatalog Snippet http://codecatalog.net/" + snip.versionptr + "/" + snip.version + "/\n" 
                 + text
                 + linecomment[snip.language] + " End CodeCatalog Snippet\n";
        };
    };

    var votedown_snip = function (versionptr) {
        post('/api/vote/', { versionptr: versionptr, value: -1 }, reload);
    };

    var voteup_snip = function (versionptr) {
        post('/api/vote/', { versionptr: versionptr, value: 1 }, reload);
    };

    // CodeCatalog Snippet http://www.codecatalog.net/32/85/
    var max = function() {
        var r = arguments[0];
        for (var i = 1; i < arguments.length; ++i) {
            if (arguments[i] > r) r = arguments[i];
        }
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/35/96/
    var min = function() {
        var r = arguments[0];
        for (var i = 1; i < arguments.length; ++i) {
            if (arguments[i] < r) r = arguments[i];
        }
        return r;
    };
    // End CodeCatalog Snippet

    var savespec = function() {
        post('/api/new/spec/', { 
            'versionptr': {{spec.versionptr}}, 
            'name': $('#name').text(),
            'summary': $('#summary').text(),
            'spec': $('#spec').val()
        });
    };

    // CodeCatalog Snippet http://www.codecatalog.net/16/119/
    var elt = function(name, attrs) {
        var r = $(document.createElement(name));
        if (attrs) {
            for (var i in attrs) {
                r.attr(i, attrs[i]);
            }
        }
        for (var i = 2; i < arguments.length; ++i) {
            r.append(arguments[i]);
        }
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/37/99/
    var button = function(text, click) {
        var r = elt('button');
        r.text(text);
        r.click(click);
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/167/451/
    var dynamic_link = function(text, click) {
        var r = elt('a', {'href': '#'}).text(text);
        r.click(function() { click(); return false; });
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/39/416/
    var horizontal = function() {
        var row = elt('tr');
        for (var i = 0; i < arguments.length; ++i) {
            var cell = elt('td', {}, arguments[i]);
            row.append(cell);
        }
        return elt('table', {}, row);
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/41/121/
    var vertical = function() {
        var r = elt('table');
        for (var i = 0; i < arguments.length; ++i) {
            var row = elt('tr', {}, elt('td', {}, arguments[i]));
            r.append(row);
        }
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/49/149/
    var label_table = function(dict) {
        var ret = elt('table');
        for (var i in dict) {
            ret.append(elt('tr', {}, 
                           elt('td', {'width': '1', 'class': 'label'}).text(i),
                           elt('td', {}, dict[i])));
        }
        return ret;
    };
    // End CodeCatalog Snippet

    var simple_select = function(options) {
        var ret = elt('select', {});
        for (var i in options) {
            ret.append(elt('option', {}).text(options[i]).val(options[i]));
        }
        return ret;
    };
    
    var dependencies_area = function(snip, replacement) {
        if (snip.dependencies.length == 0) {
            return $('');
        }
        
        var b = button('Dependencies', function() {
            var table = elt('table');
            snip.dependencies.forEach(function (dep) {
                $.get('/api/specs/' + dep + '/active/', function (result) {
                    table.append(
                        elt('tr', {}, 
                            elt('td', {},
                                elt('a', { href: '/' + result.versionptr + '/' },
                                    elt('tt').text(result.name))),
                            elt('td', {}).text(result.summary)));
                });
            });
            table.append(replacement());
            b.replaceWith(table);
        });
        return b;
    };

    var assemble = function(snips) {
        var str = "";
        for (var i in snips) {
            str += snips[i].code + "\n";
        }
        return str;
    };
    var assemble_and_tag = function(snips) {
        var str = "";
        for (var i in snips) {
            str += annotator(snips[i])(snips[i].code) + "\n";
        }
        return str;
    };

    var display_snip_version = function(snip) {
        var textarea = elt('textarea', { rows:30, readonly: 'readonly', 'class': 'cc_code', wrap: 'off' });
        textarea.val(snip.code);
        textarea.attr('rows', linecount(snip.code));
        select_on_click(textarea, annotator(snip));
        
        var deps_area = dependencies_area(snip, function() {
            var expand_deps_button = elt('button', {}).text("Expand All");
            expand_deps_button.click(function() {
                $.get('/api/snippet/' + snip.version + '/assemble/', function(snips) {
                    if (!snips) {
                        alert("Couldn't expand dependencies.  Possibly because of a circular " +
                              "dependency, or dependency on a spec with no implementations in " + snip.language);
                        return;
                    }
                    var code = assemble(snips);
                    var code_tagged = assemble_and_tag(snips);
                    var newtextarea = elt('textarea', { rows: 30, readonly: 'readonly', 'class': 'cc_code', wrap: 'off'});
                    // TODO evilness  (undo it I mean)
                    newtextarea.attr('rows', linecount(code));
                    newtextarea.val(code);
                    select_on_click(newtextarea, function() { return code_tagged; });
                    textarea.replaceWith(newtextarea);
                    textarea = newtextarea;
                    expand_deps_button.remove();  // TODO toggle instead
                });
            });
            return expand_deps_button;
        });
        
        return vertical(
            textarea,
            horizontal(
                elt('span', {'class': 'language'}).text(snip.language),
                deps_area)).addClass("snippet");
                
    };

    var display_snips_history = function(snips) {
        var table = elt('table');
        for (var i in snips) {
            (function() {
                var snip = snips[i];
                var info;
                if (snip.active || !logged_in) {
                    info = $('');
                }
                else {
                    info = dynamic_link('Revert to this version', function() {
                        var newsnip = $.extend({}, snip);
                        newsnip.dependencies = snip.dependencies.join(',');
                        newsnip.comment = "Revert to version " + snip.versionptr + "/" + snip.version;
                        delete newsnip.version;
                        $.post('/api/new/snippet/', newsnip, reload);
                    });
                }
                var comment = elt('span', {}, snip.comment);
                if (!comment) {
                    comment = elt('span', {}, "<No comment>");
                }
                var d = vertical(display_snip_version(snip), elt('span', {}, comment, elt('span').text("-- by " + snip.user)));
                table.append(elt('tr', {}, elt('td', {}, horizontal(d, info))));
            })();
        }
        return table;
    };

    var display_snip_history = function(snip) {
        var div = elt('div');
        $.get('/api/snippets/' + snip.versionptr + '/all/', function(snips) {
            snips.sort(function(a,b) {
                return a.timestamp < b.timestamp ? 1 : -1;
            });
            div.append(display_snips_history(snips));
        });
        return div;
    };

    var tabs = function(ts) {
        var tablabels = elt('tr');
        var tabtable = elt('table', { 'class': 'tabstrip' }, tablabels);
        var content = elt('div', { 'class': 'content' });
        var container = elt('div', { 'class': 'tabs' }, tabtable, content); 
        var cur;

        for (var i in ts) {
            (function() {
                var t = ts[i];
                var cb = function() {
                    if (!t.contentCache) {
                        if (typeof t.content == "function") {
                            t.contentCache = t.content();
                        }
                        else {
                            t.contentCache = t.content;
                        }
                        content.append(t.contentCache);
                    }
                    if (cur) { 
                        cur.contentCache.addClass('hidden'); 
                        cur.tab.removeClass('selected');
                    }
                    cur = t;
                    t.contentCache.removeClass('hidden');
                    t.tab.addClass('selected');
                };
                t.tab = elt('td', { 'class': 'tab' }).text(t.label);
                t.tab.click(cb);
                tablabels.append(t.tab);
                if (i == 0) cb();
            })();
        }
        
        return container;
    };

    var display_snip_container = function(snip) {
        return tabs([
            { label: 'Active', content: function() { return display_snip_versionptr(snip) } },
            { label: 'History', content: function() { return display_snip_history(snip) } },
        ]).addClass('snippet_box');
    };

    var display_snip_versionptr = function(snip) {
        var div = elt('div');

        var votesbox = elt('span');
        votesbox.text(snip.votes);

        var edit = function() {
            div.replaceWith(code_editor(snip, function(newsnip) {
                $.post('/api/new/snippet/', newsnip, reload);
            }));
        };

        var votes;
        if (logged_in) {
            votes = horizontal(
                        button('-', function() { votedown_snip(snip.versionptr) }),
                        votesbox,
                        button('+', function() { voteup_snip(snip.versionptr) }));
        }
        else {
            votes = elt('span',{}, votesbox);
        }

        var infoarea = 
            vertical(
                votes,
                button("edit", edit));

        div.append(horizontal(display_snip_version(snip), infoarea));
        return div;
    };

    var render_bug = function(bug) {
        var details = elt('a', {href:'#'}).text("Details...");
        var cls = 
            bug.status == 'Open'     ? 'open' :
            bug.status == 'Resolved' ? 'resolved' :
            bug.status == 'Closed'   ? 'closed'
                                     : 'unknown';
        var ret = elt('div', {'class': cls},
            elt('p').text(bug.title).append(
                elt('b').text(" -- " + bug.status + ". "),
                details));
        details.click(function() {
            ret.replaceWith(render_bug_details(bug));
            return false;
        });
        return ret; 
    };

    var render_bug_details = function(bug) {
        var div = elt('div').addClass("details");
        $.get('/api/bugs/' + bug.versionptr + '/all/', function(bugs) {
            for (var i in bugs) {
                div.append(render_bug_version(bugs[i]));
            }
            var link = button('Update', function() {
                var last = bugs[bugs.length-1];
                link.replaceWith(bug_edit_box(last.target_versionptr, last, render_bug_version));
            });
            div.append(link);
            div.append(button('Hide', function() { div.replaceWith(render_bug(bug)) }));
        });
        return div;
    };

    var render_bug_version = function(bug) {
        return elt('div', {}, 
            horizontal(elt('b').text(bug.title), elt('span').text(bug.user || 'Anonymous'), elt('span').text(bug.status)),
            elt('p').text(bug.comment));
    };

    var bug_edit_box = function(target, bug, cont) {
        var newdiv = elt('div', { 'class': 'editor' });
        var input = elt('input', { type: 'text' }).val(bug.title);
        var textarea = elt('textarea');
        var select = simple_select([ 'Open', 'Resolved', 'Closed' ]);
        select.val(bug.status || 'Open');
        
        var btn = button('OK', function() {
            var newbug = { target_versionptr: target, title: input.val(), comment: textarea.val(), status: select.val(), user: '{{user.username}}' };
            if (bug.versionptr) { newbug['versionptr'] = bug.versionptr; }
            
            post('/api/new/bug/', newbug, function(r) {
                newbug.version = r.version;
                newbug.versionptr = r.versionptr;
            });
            
            newdiv.replaceWith(cont(newbug));
        });
        var cancelbtn = button('Cancel', function() { newdiv.remove() });
        newdiv.append(label_table({
                'Bug Title': input,
                'Status': select,
                'Details/Comment': textarea}),
            btn, cancelbtn);
        return newdiv;
    };

    var bugs_box = function(versionptr) {
        var div = elt('div', { 'class': 'bugs' });

        var newbug = elt('a', { href: '#' }).text("Report Bug");
        newbug.click(function() {
            newbug.before(bug_edit_box(versionptr, {}, render_bug));
            return false;
        });
        div.append(newbug);
        
        $.get('/api/specs/' + versionptr + '/bugs/active/', function(bugs) {
            for (var i in bugs) {
                div.prepend(render_bug(bugs[i]));
            }
        });
        return div;
    };

    $(function() {
        var e = editable({ onedit: function() { savespec(); } });
        e.installEditButtons();
        
        makeMarkdownArea($('#spec'), 'spec', function(text) { 
            savespec();
        });

        $('#spec_bugs').append(bugs_box({{spec.versionptr}}));

        $('.snippet').each(function (i,e) {
            e = $(e);
            var data = JSON.parse(e.find('.data').val());
            var snip = display_snip_container(data);
            e.replaceWith(snip);
            snip.after(bugs_box(data.versionptr));
        });

        $('#addsnippet').click(function() {
            var proto = {
                spec_versionptr: {{spec.versionptr}},
            };
            $('#addsnippet').replaceWith(code_editor(proto, function(newsnip) {
                $.post('/api/new/snippet/', newsnip, reload);
            }));
        });
    });
  </script>
{% endblock scripting %}
{% endblock header %}

{% block content %}

{% block alert %}
{% endblock %}

{% block spec %}
<h1 class="spec_name"><span id="name" name="name" class="editable">{% block title %}{{spec.name}}{% endblock %}</span></h1>
<span id="summary" name="summary" class="summary editable">{{spec.summary}}</span>
<textarea id="spec" name="spec" rows="30" class="cc_code">{{spec.spec}}</textarea>
<div id="spec_bugs"></div>
{% endblock spec %}

{% block impls %}
{% for snip in snippets %}
<div class="snippet">
 <textarea class="code" readonly="readonly">{{snip.code}}</textarea>
 <textarea class="data hidden" readonly="readonly">{{snip|json}}</textarea>
</div>
{% endfor %}

<button name="addsnippet" id="addsnippet">Add Snippet</button>
{% endblock impls %}
{% endblock content %}
