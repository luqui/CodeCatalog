{% extends "zoo/frame.html" %}
{% load json_dump %}

{% block pagetitle %}
{{spec.name}} - CodeCatalog
{% endblock %}

{% block header %}
  
  <script type="text/javascript" src="/static/editable.js"></script>
  <script type="text/javascript" src="/static/select_on_click.js"></script>
  <script type="text/javascript" src="/static/showdown.js"></script>
  <script type="text/javascript" src="/static/editable_markdown.js"></script>
  <script type="text/javascript" src="/static/code_editor.js"></script>
  <script type="text/javascript" src="/static/shjs/sh_main.js"></script>
  <link rel="stylesheet" type="text/css" href="/static/shjs/sh_style.css" />

  <style>
    .hidden { display: none; visibility: hidden; width: 10px }
    .data { display: none; visibility: hidden; width: 10px }
    .cc_code { width: 750px; background: white }
    .cc_history { width: 650px }

    .snip_code { }
    .deps_area { display: block; }

    /* Alert */
    .alert { background: #fd9 }

    /* Documentation */
    .spec_name { font-family: monospace; margin-bottom: 0px }
    .summary { margin-left: 1cm; font-style: italic }
    .spec { background: #eee; margin-top: 1cm }
    .spec h1 { font-size: 16pt; text-decoration: underline }
    .spec h2 { font-size: 14pt }
    .spec pre { padding-left: 1cm; background: #ccc }

    .spec_controls { float: right }
    .spec_history_table { border: 1px solid black; background: #ddf }
    .spec_history_table textarea { background: #eee }

    /* Snippet box */
    .snippet_box textarea { 
        background: #eee;
    }
    .snippet_box {
        margin-top: 1cm;
    }
    
    .tabs .tabstrip { border-spacing: 0; border-collapse: collapse; }
    .tabs .tab { 
        background: #ab8;
        padding-right: 1cm;
        border-left: solid 2px #bc9;
        border-top: solid 2px #bc9;
        border-right: solid 2px #9a7;
        border-bottom: solid 1px #9a7;
        cursor: pointer;
        display: inline-block;
    }
    .tabs .tab.selected {
        border-left: solid 2px #deb;
        border-top: solid 2px #deb;
        border-bottom: solid 1px #cda;
        background: #cda;
    }
    .tabs .content {
        background: #cda;
        padding: 4px;
    }
    .language { 
        font-weight: bold; 
        font-style: italic;
        text-transform: capitalize; 
        float: right;
        padding-right: 10px;
        padding-top: 5px;
        display: block;
        clear: right;
    }
    .infoarea {
        float: right;
    }
    .edit_comment {
        font-style: italic;
    }

    /* Bugs box */
    .bugs { margin-left: 1in }
    .bugs .open { color: #f66 }
    .bugs .resolved { color: #6a6 }
    .bugs .closed { color: #666 }
    .bugs table, .bugs input, .bugs textarea { width: 100% }
    .bugs textarea { height: 1in }
    .bugs .details, .bugs .editor { border: 1px solid black; background: #feb }
  </style>

{% block scripting %}

  <script type="text/javascript">
    // CodeCatalog Snippet http://www.codecatalog.net/18/45/
    var reload = function() { document.location.reload(); };
    // End CodeCatalog Snippet
    
    // CodeCatalog Snippet http://www.codecatalog.net/30/686/
    var language_to_line_comment_map = {
        python: '#',
        javascript: '//',
        haskell: '--',
        c: '//',
        csharp: '//',
        java: '//', 
        ruby: '#'
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/16/119/
    var elt = function(name, attrs) {
        var r = $(document.createElement(name));
        if (attrs) {
            for (var i in attrs) {
                r.attr(i, attrs[i]);
            }
        }
        for (var i = 2; i < arguments.length; ++i) {
            r.append(arguments[i]);
        }
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/37/99/
    var button = function(text, click) {
        var r = elt('button');
        r.text(text);
        r.click(click);
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/167/451/
    var dynamic_link = function(text, click) {
        var r = elt('a', {'href': '#'}).text(text);
        r.click(function() { click(); return false; });
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/39/669/
    var horizontal = function() {
        var row = elt('tr');
        for (var i = 0; i < arguments.length; ++i) {
            var cell = elt('td', {}, arguments[i]);
            row.append(cell);
        }
        return elt('table', {}, row);
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/41/121/
    var vertical = function() {
        var r = elt('table');
        for (var i = 0; i < arguments.length; ++i) {
            var row = elt('tr', {}, elt('td', {}, arguments[i]));
            r.append(row);
        }
        return r;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/49/498/
    var label_table = function(dict) {
        var ret = elt('table');
        for (var i in dict) {
            ret.append(elt('tr', {}, 
                           elt('td', {'width': '1', 'class': 'label'}).text(i),
                           elt('td', {}, dict[i])));
        }
        return ret;
    };
    // End CodeCatalog Snippet
    
    // CodeCatalog Snippet http://www.codecatalog.net/248/692/
    var simple_select = function(options) {
        var ret = elt('select', {});
        for (var i in options) {
            ret.append(elt('option', {}).text(options[i]).val(options[i]));
        }
        return ret;
    };
    // End CodeCatalog Snippet
    
    // CodeCatalog Snippet http://www.codecatalog.net/250/697/
    var lazy_highlight_element = function(prefix, suffix, element, language) {
        if (language in sh_languages) {
            if (sh_languages[language]) {
                sh_highlightElement(element, sh_languages[language]);
            }
        }
        else {
            $.get(prefix + 'sh_' + language + suffix, function(reply) {
                eval(reply);
                sh_highlightElement(element, sh_languages[language]);
            }).error(function() {
                sh_languages[language] = null;
            });
        }
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/252/704/
    var escape_html = function(html) {
        return html.split('&').join('&amp;')
                   .split('<').join('&lt;')
                   .split('>').join('&gt;');
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/181/718/
    var tabs = function(ts) {
        var tabtable = elt('div', { 'class': 'tabstrip' });
        var content = elt('div', { 'class': 'content' });
        var container = elt('div', { 'class': 'tabs' }, tabtable, content); 
        var cur;
    
        for (var i in ts) {
            (function() {
                var t = ts[i];
                var cb = function() {
                    if (!t.contentCache) {
                        if (typeof t.content == "function") {
                            t.contentCache = t.content();
                        }
                        else {
                            t.contentCache = t.content;
                        }
                        content.append(t.contentCache);
                    }
                    if (cur) { 
                        cur.contentCache.hide();
                        cur.tab.show();
                        cur.tab.removeClass('selected');
                    }
                    cur = t;
                    t.contentCache.show();
                    t.tab.addClass('selected');
                };
                t.tab = elt('span', { 'class': 'tab' }).text(t.label);
                t.tab.click(cb);
                tabtable.append(t.tab);
                if (i == 0) cb();
            })();
        }
        
        return container;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/254/713/
    var table_row = function() {
        var tr = elt('tr');
        for (var i in arguments) {
            tr.append(elt('td', {}, arguments[i]));
        }
        return tr;
    };
    // End CodeCatalog Snippet

    // CodeCatalog Snippet http://www.codecatalog.net/256/715/
    var text_node = function(text) { return document.createTextNode(text) };
    // End CodeCatalog Snippet

    var logged_in = '{{user.is_authenticated}}' == 'True';

    var post = function(url, dict, callback) {
        dict['csrfmiddlewaretoken'] = '{{csrf_token}}';
        $.post(url, dict, callback);
    };

    var annotator = function (snip) { 
        return function (text) {
            return language_to_line_comment_map[snip.language] + " CodeCatalog Snippet http://codecatalog.net/" + snip.versionptr + "/" + snip.version + "/\n" 
                 + text
                 + language_to_line_comment_map[snip.language] + " End CodeCatalog Snippet\n";
        };
    };

    var savespec = function(cont, comment) {
        post('/api/new/spec/', { 
            'versionptr': {{spec.versionptr}}, 
            'name': $('#name').text(),
            'summary': $('#summary').text(),
            'spec': $('#spec').val(),
            'status': $('#spec_status').val(),
            'comment': comment},
        	function(r) {
            	if (cont) cont();
        	});
    };

    
    var dependencies_area = function(snip) {
        if (snip.dependencies.length == 0) {
            return $([]);
        }
        
        var table = elt('table');
        snip.dependencies.forEach(function (dep) {
            $.get('/api/specs/' + dep + '/active/', function (result) {
                table.append(
                    table_row(
                        elt('a', { href: '/' + result.versionptr + '/' }, text_node(result.name)),
                        text_node(result.summary)));
            });
        });
        return table;
    };

    var assemble = function(snips) {
        var str = "";
        for (var i in snips) {
            str += snips[i].code + "\n";
        }
        return str;
    };
    var assemble_and_tag = function(snips) {
        var str = "";
        for (var i in snips) {
            str += annotator(snips[i])(snips[i].code) + "\n";
        }
        return str;
    };

    var highlighted_code_pre = function(code, tagged_code, language) {
        var div = elt('div');
        if ($.browser.msie) {
            var pre = $('<pre class="cc_code">' + escape_html(code) + '</pre>');
        }
        else {
            var pre = elt('pre', {'class': 'cc_code'}).text(code);
        }
        lazy_highlight_element('/static/shjs/lang/', '.min.js', pre[0], language);

        var textarea = elt('textarea', {
            'rows': linecount(tagged_code), 
            'class': 'cc_code', 
            'readonly': 'readonly', 
            'wrap': 'off'
        }).val(tagged_code);
        textarea.hide();

        pre.click(function() {
            pre.hide();
            textarea.show();
            textarea.focus();
            textarea.select();
        });
        textarea.blur(function() {
            pre.show();
            textarea.hide();
        });
        div.append(pre, textarea);
        return div;
    };

    var display_snip_version = function(snip) {
        var textarea = highlighted_code_pre(snip.code, annotator(snip)(snip.code), snip.language).addClass('snip_code');
        
        var expand_deps_button = button("Expand All Dependencies", function () {
            $.get('/api/snippet/' + snip.version + '/assemble/', function(snips) {
                if (!snips) {
                    alert("Couldn't expand dependencies.  Possibly because of a circular " +
                          "dependency, or dependency on a spec with no implementations in " + snip.language);
                    return;
                }
                var code = assemble(snips);
                var code_tagged = assemble_and_tag(snips);
                var newtextarea = highlighted_code_pre(code, code_tagged, 'javascript');
                // TODO evilness  (undo it I mean)
                textarea.replaceWith(newtextarea);
                textarea = newtextarea;
                expand_deps_button.remove();  // TODO toggle instead
            });
        });

        var deps_area = expand_deps_button.add(dependencies_area(snip)).addClass('deps_area');

        return elt('span', {'class': 'language'}).text(snip.language)
                 .add(textarea)
                 .add(deps_area);
    };

    var display_snips_history = function(snips) {
        var table = elt('div');
        for (var i in snips) {
            (function() {
                var snip = snips[i];
                var info;
                if (snip.active || !logged_in) {
                    info = $([]);
                }
                else {
                    info = dynamic_link('Revert to this version', function() {
                        var newsnip = $.extend({}, snip);
                        newsnip.dependencies = snip.dependencies.join(',');
                        newsnip.comment = "Revert to version " + snip.versionptr + "/" + snip.version;
                        delete newsnip.version;
                        $.post('/api/new/snippet/', newsnip, reload);
                    }).addClass('infoarea');
                }
                var comment;
                if (snip.comment) {
                    comment = elt('span').text(snip.comment);
                }
                else {
                    comment = elt('span').text("<No comment>");
                }
                var d = elt('div', {}, info.add(display_snip_version(snip)).add(elt('span', { 'class': 'edit_comment' }, comment, elt('span').text(" -- by " + snip.user))));
                table.append(d);
            })();
        }
        return table;
    };

    var display_snip_history = function(snip) {
        var div = elt('div');
        $.get('/api/snippets/' + snip.versionptr + '/all/', function(snips) {
            snips.sort(function(a,b) {
                return a.timestamp < b.timestamp ? 1 : -1;
            });
            div.append(display_snips_history(snips));
        });
        return div;
    };

    var display_spec_version = function(spec) {
        return function (info) {
            if (spec.status == 'Deprecated') {
                info = vertical(elt('b').text('DEPRECATED'), info);
            }
            return horizontal(
                elt('table', { 'class': 'spec_history_table' },
                    elt('tr', {},
                        elt('td').text("Title"),
                        elt('td').text(spec.title)),
                    elt('tr', {},
                        elt('td').text("Summary"),
                        elt('td').text(spec.summary)),
                    elt('tr', {},
                        elt('td').text("Description"),
                        elt('td', {}, elt('textarea', { 'readonly': 'readonly', 'class': 'cc_history', 'rows': 10 }).val(spec.spec)))),
                info);
        };
    };

    var display_specs_history = function(specs) {
        var table = elt('table');
        for (var i in specs) {
            (function() {
                var spec = specs[i];
                var info;
                if (spec.active || !logged_in) {
                    info = $('');
                }
                else {
                    info = dynamic_link('Revert to this version', function() {
                        var newspec = $.extend({}, spec);
                        newspec.comment = "Revert to version " + spec.versionptr + "/" + spec.version;
                        delete newspec.version;
                        $.post('/api/new/spec/', newspec, reload);
                    });
                }
                var comment;
                if (spec.comment) {
                    comment = elt('span').text(spec.comment);
                }
                else {
                    comment = elt('span').text("<No comment>");
                }
                var d = vertical(display_spec_version(spec)(info), elt('span', {}, comment, elt('span').text('-- by ' + spec.user)));
                table.append(elt('tr', {}, elt('td', {}, d)));
            })();
        }
        return table;
    };

    var display_spec_history = function(spec) {
        var div = elt('div');
        $.get('/api/specs/' + spec.versionptr + '/all/', function (specs) {
            specs.sort(function(a,b) {
                return a.timestamp < b.timestamp ? 1 : -1;
            });
            div.append(display_specs_history(specs));
        });
        return div;
    };

    var display_snip_container = function(snip) {
        return tabs([
            { label: 'Active', content: function() { return display_snip_versionptr(snip) } },
            { label: 'History', content: function() { return display_snip_history(snip) } }
            ]).addClass('snippet_box');
    };

    var display_snip_versionptr = function(snip) {
        var edit = function() {
            if (!editbutton()) return;
            infoarea.remove();
            version_display.replaceWith(code_editor(snip, function(newsnip) {
                $.post('/api/new/snippet/', newsnip, reload);
            }));
        };

        var version_display = display_snip_version(snip);
        var infoarea = elt('div', { 'class': 'infoarea' }, 
                            button("edit", edit));

        return infoarea.add(version_display);
    };

    var render_bug = function(bug) {
        var details = elt('a', {href:'#'}).text("Details...");
        var cls = 
            bug.status == 'Open'     ? 'open' :
            bug.status == 'Resolved' ? 'resolved' :
            bug.status == 'Closed'   ? 'closed'
                                     : 'unknown';
        var ret = elt('div', {'class': cls},
            elt('p').text(bug.title).append(
                elt('b').text(" -- " + bug.status + ". "),
                details));
        details.click(function() {
            ret.replaceWith(render_bug_details(bug));
            return false;
        });
        return ret; 
    };

    var render_bug_details = function(bug) {
        var div = elt('div').addClass("details");
        $.get('/api/bugs/' + bug.versionptr + '/all/', function(bugs) {
            for (var i in bugs) {
                div.append(render_bug_version(bugs[i]));
            }
            var link = button('Update', function() {
                var last = bugs[bugs.length-1];
                link.replaceWith(bug_edit_box(last.target_versionptr, last, render_bug_version));
            });
            div.append(link);
            div.append(button('Hide', function() { div.replaceWith(render_bug(bug)) }));
        });
        return div;
    };

    var render_bug_version = function(bug) {
        return elt('div', {}, 
            horizontal(elt('b').text(bug.title), elt('span').text(bug.user || 'Anonymous'), elt('span').text(bug.status)),
            elt('p').text(bug.comment));
    };

    var bug_edit_box = function(target, bug, cont) {
        var newdiv = elt('div', { 'class': 'editor' });
        var input = elt('input', { type: 'text' }).val(bug.title);
        var textarea = elt('textarea');
        var select = simple_select([ 'Open', 'Resolved', 'Closed' ]);
        select.val(bug.status || 'Open');
        
        var btn = button('OK', function() {
            var newbug = { target_versionptr: target, title: input.val(), comment: textarea.val(), status: select.val(), user: '{{user.username}}' };
            if (bug.versionptr) { newbug['versionptr'] = bug.versionptr; }
            
            post('/api/new/bug/', newbug, function(r) {
                newbug.version = r.version;
                newbug.versionptr = r.versionptr;
            });
            
            newdiv.replaceWith(cont(newbug));
        });
        var cancelbtn = button('Cancel', function() { newdiv.remove() });
        newdiv.append(label_table({
                'Bug Title': input,
                'Status': select,
                'Details/Comment': textarea}),
            btn, cancelbtn);
        return newdiv;
    };

    var bugs_box = function(versionptr) {
        var div = elt('div', { 'class': 'bugs' });

        var newbug = elt('a', { href: '#' }).text("Report Bug");
        newbug.click(function() {
            newbug.before(bug_edit_box(versionptr, {}, render_bug));
            return false;
        });
        div.append(newbug);
        
        $.get('/api/specs/' + versionptr + '/bugs/active/', function(bugs) {
            for (var i in bugs) {
                div.prepend(render_bug(bugs[i]));
            }
        });
        return div;
    };

    var editbutton = function() {
        if (logged_in) {
            return true;
        }
        else {
            var path = window.location.pathname;
            window.location.href = '/openid/login/?next=' + escape(path);
            return false;
        }
    };

    $(function() {
        editable({ 
                onedit: function() { savespec(); },
                custom_on_click: editbutton})
            .installEditButtons();
        
        makeMarkdownArea($('#spec'), 'spec', function(text, comment) { 
            savespec(null, comment);
        }, editbutton);

        $('#spec_history').click(function () {
            $('#spec_region').replaceWith(display_spec_history(JSON.parse($('#spec_data').val())));
            return false;
        });

        $('#spec_bugs').append(bugs_box({{spec.versionptr}}));

        $('.snippet').each(function (i,e) {
            e = $(e);
            var data = JSON.parse(e.find('.data').val());
            var snip = display_snip_container(data);
            e.replaceWith(snip);
            snip.after(bugs_box(data.versionptr));
        });

        $('#addsnippet').click(function() {
            var proto = {
                spec_versionptr: {{spec.versionptr}}};
            $('#addsnippet').replaceWith(code_editor(proto, function(newsnip) {
                $.post('/api/new/snippet/', newsnip, reload);
            }));
        });

        var spec_status = $('#spec_status');
        if (spec_status.length) {
            spec_status.change(function() {
                var s = spec_status.val();
                if (s != "{{spec.status}}") {
                    if (confirm("Are you sure you want to mark this spec as " + s + "?")) {
                        savespec(reload);
                    }
                    else {
                        spec_status.val("{{spec.status}}");
                    }
                }
            });
        }
    });
  </script>
{% endblock scripting %}
{% endblock header %}

{% block content %}

{% block alert %}
 {% if spec.status == 'Deprecated' %} 
  <div class="alert">
  This spec is <b>Deprecated</b>.  Typically this means that there is a strictly better 
  alternative that is documented on this page.
  </div>
 {% endif %}
{% endblock %}

{% block spec %}
<div id="spec_region">
 <h1 class="spec_name"><span id="name" name="name" class="editable">{% block title %}{{spec.name}}{% endblock %}</span></h1>
 <div class="spec_controls">
   <div>
    <a id="spec_history" name="spec_history" href="#">History</a>
   </div>
   {% if user.is_authenticated %}
   <div>
    <select id="spec_status" name="spec_status">
     <option value="Open" {%if spec.status == 'Open' %}selected{%endif%}>Open</option>
     <option value="Deprecated" {%if spec.status == 'Deprecated' %}selected{%endif%}>Deprecated</option>
    </select>
   </div>
   {% endif %}
 </div>
 <span id="summary" name="summary" class="summary editable">{{spec.summary}}</span>
 <textarea id="spec" name="spec" rows="30" class="cc_code">{{spec.spec}}</textarea>
 <textarea id="spec_data" name="spec_data" class="hidden" readonly="readonly">{{spec|json}}</textarea>
</div>
<div id="spec_bugs"></div>
{% endblock spec %}

{% block impls %}
{% for snip in snippets %}
<div class="snippet">
 <pre class="code" readonly="readonly">{{snip.code}}</pre>
 <textarea class="data hidden" readonly="readonly">{{snip|json}}</textarea>
</div>
{% endfor %}

<button name="addsnippet" id="addsnippet">Add Snippet</button>
{% endblock impls %}
{% endblock content %}
